import { describe, it, expect } from 'vitest';
import { TestProject } from '../utils';

describe('Auto Imports', () => {
  it('should output types for entrypoint paths', async () => {
    const project = new TestProject();
    project.addFile(
      'entrypoints/background.ts',
      'export default defineBackgroundScript(() => {})',
    );
    project.addFile(
      'entrypoints/overlay.content.ts',
      'export default defineContentScript(() => {})',
    );
    project.addFile('entrypoints/popup.html', '<html></html>');

    await project.build();

    expect(await project.serializeFile('.exvite/types/paths.d.ts'))
      .toMatchInlineSnapshot(`
        ".exvite/types/paths.d.ts
        ----------------------------------------
        // Generated by exvite
        type EntrypointPath =
          | \\"/background.js\\"
          | \\"/content-scripts/overlay.js\\"
          | \\"/popup.html\\"
        "
      `);
  });

  it('should make some client utils auto-importable', async () => {
    const project = new TestProject();
    project.addFile('entrypoints/popup.html', `<html></html>`);

    await project.build();

    expect(await project.serializeFile('.exvite/types/imports.d.ts'))
      .toMatchInlineSnapshot(`
      ".exvite/types/imports.d.ts
      ----------------------------------------
      // Generated by exvite
      export {}
      declare global {
        const browser: typeof import('webextension-polyfill')
        const defineBackgroundScript: typeof import('exvite/client')['defineBackgroundScript']
        const defineConfig: typeof import('exvite')['defineConfig']
        const defineContentScript: typeof import('exvite/client')['defineContentScript']
        const mountContentScriptUi: typeof import('exvite/client')['mountContentScriptUi']
      }
      "
    `);
  });
});
